# Set all running containers bridged
description "Set all running containers bridged"
start on filesystem and started docker


script
	JOB=docker
	TIMEOUT=330
	start_time=`date "+%s"`
	until status $JOB | grep start/running >/dev/null; do
		if [ $((`date "+%s"` - $start_time)) -gt $TIMEOUT ]; then 
			exit 1
		fi
		sleep 1
	done
	sleep 5
	containers=$( docker ps -q )
	for contid in ${containers}
	do
		bridge=$(docker inspect --format='{{.Config.Env}}' ${contid} | grep -Po 'BRIDGED=([^\s]*)')
		if [ ${bridge} ]; then
			bridge="${bridge#BRIDGED=}"
			if [ ${bridge} ]; then
				pipework br0 ${contid} ${bridge}
			fi
		fi
	done
end script
